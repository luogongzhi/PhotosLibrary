{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["\nimport type { IPluginContext, TaroPlatformBase } from '@tarojs/service'\nimport { isArray, isString } from '@tarojs/shared'\nimport * as path from 'path'\nimport * as parser from '@babel/parser'\nimport traverse from '@babel/traverse'\nimport * as t from '@babel/types'\nimport generator from '@babel/generator'\n\ninterface IOptions {\n  pxtransformBlackList?: any[]\n  modifyElements?(inline: string[], block: string[]): void\n  enableSizeAPIs?: boolean\n}\n\ninterface IComponentConfig {\n  includes: Set<string>\n}\n\ninterface OnParseCreateElementArgs {\n  nodeName: string\n  componentConfig: IComponentConfig\n}\n\ninterface ModifyComponentConfigArgs {\n  componentConfig: IComponentConfig,\n  config: Record<string, any>\n}\n\nexport default (ctx: IPluginContext, options: IOptions) => {\n  const inlineElements = ['i', 'abbr', 'select', 'acronym', 'small', 'bdi', 'kbd', 'strong', 'big', 'map', 'sub', 'sup', 'br', 'mark', 'meter', 'template', 'cite', 'object', 'time', 'code', 'output', 'u', 'data', 'picture', 'tt', 'datalist', 'var', 'dfn', 'del', 'q', 'em', 's', 'embed', 'samp', 'b']\n  const blockElements = ['body', 'svg', 'address', 'fieldset', 'li', 'span', 'article', 'figcaption', 'main', 'aside', 'figure', 'nav', 'blockquote', 'footer', 'ol', 'details', 'p', 'dialog', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'pre', 'dd', 'header', 'section', 'div', 'hgroup', 'table', 'dl', 'hr', 'ul', 'dt', 'view', 'view-block']\n  const specialElements = ['slot', 'form', 'iframe', 'img', 'audio', 'video', 'canvas', 'a', 'input', 'label', 'textarea', 'progress', 'button']\n\n  patchMappingElements(ctx, options, inlineElements, blockElements)\n\n  // 默认允许使用 getBoundingClientRect 等 API\n  ctx.modifyWebpackChain(({ chain }) => {\n    chain\n      .plugin('definePlugin')\n      .tap(args => {\n        args[0].ENABLE_SIZE_APIS = options.enableSizeAPIs ?? true\n        return args\n      })\n  })\n  ctx.registerMethod({\n    name: 'onSetupClose',\n    fn (platform: TaroPlatformBase) {\n      injectRuntimePath(platform)\n      modifyPostcssConfigs(platform.config, options)\n    }\n  })\n  // React 收集使用到的小程序组件\n  ctx.onParseCreateElement(({ nodeName, componentConfig }: OnParseCreateElementArgs) => {\n    if (!(\n      inlineElements.includes(nodeName) ||\n      blockElements.includes(nodeName) ||\n      specialElements.includes(nodeName)\n    )) return\n\n    const simple = ['audio', 'button', 'canvas', 'form', 'label', 'progress', 'textarea', 'video']\n    const special = {\n      a: ['navigator'],\n      iframe: ['web-view'],\n      img: ['image'],\n      input: ['input', 'checkbox', 'radio']\n    }\n    const includes = componentConfig.includes\n\n    if (simple.includes(nodeName) && !includes.has(nodeName)) {\n      includes.add(nodeName)\n    } else if (nodeName in special) {\n      const maps = special[nodeName]\n      maps.forEach(item => {\n        !includes.has(item) && includes.add(item)\n      })\n    }\n  })\n  // 如果组件使用渲染函数而不是模板，我们分析不了使用到的内置组件，所以只能默认加上所有 HTML 对应的小程序组件模板\n  ctx.modifyComponentConfig(({ componentConfig, config }: ModifyComponentConfigArgs) => {\n    if (config.framework === 'vue' || config.framework === 'vue3') {\n      ['audio', 'button', 'canvas', 'form', 'label', 'progress', 'textarea', 'video', 'navigator', 'web-view', 'image', 'input', 'checkbox', 'radio'].forEach(item => {\n        componentConfig.includes.add(item)\n      })\n    }\n  })\n  // 修改 H5 postcss options\n  ctx.modifyRunnerOpts(({ opts }) => {\n    modifyPostcssConfigs(opts, options, true)\n  })\n}\n\nfunction injectRuntimePath (platform: TaroPlatformBase) {\n  const injectedPath = '@tarojs/plugin-html/dist/runtime'\n  if (isArray(platform.runtimePath)) {\n    platform.runtimePath.push(injectedPath)\n  } else if (isString(platform.runtimePath)) {\n    platform.runtimePath = [platform.runtimePath, injectedPath]\n  }\n}\n\nfunction modifyPostcssConfigs (config: Record<string, any>, options: IOptions, isH5?: boolean) {\n  config.postcss ||= {}\n  const postcssConfig = config.postcss\n\n  if (!isH5) {\n    postcssConfig.htmltransform = {\n      enable: true\n    }\n  }\n\n  if (options.pxtransformBlackList) {\n    postcssConfig.pxtransform ||= {\n      enable: true\n    }\n    const pxtransformConfig = postcssConfig.pxtransform\n\n    if (pxtransformConfig.enable) {\n      pxtransformConfig.config ||= {}\n      const config = pxtransformConfig.config\n      config.selectorBlackList ||= []\n      config.selectorBlackList = config.selectorBlackList.concat(options.pxtransformBlackList)\n    }\n  }\n}\n\nfunction patchMappingElements (ctx: IPluginContext, options: IOptions, inlineElements: string[], blockElements: string[]) {\n  const helper = ctx.helper\n  const filePath = path.resolve(__dirname, './runtime.js')\n  const content = helper.fs.readFileSync(filePath).toString()\n  const ast = parser.parse(content, { sourceType: 'unambiguous' })\n\n  options.modifyElements?.(inlineElements, blockElements)\n\n  traverse(ast, {\n    VariableDeclarator (path) {\n      const node = path.node\n      const varid = node.id\n      if (varid.type === 'Identifier') {\n        if (varid.name === 'inlineElements') {\n          node.init = getNewExpression(inlineElements)\n        }\n        if (varid.name === 'blockElements') {\n          node.init = getNewExpression(blockElements)\n        }\n      }\n    }\n  })\n\n  const str = generator(ast).code\n  helper.fs.writeFileSync(filePath, str)\n}\n\nfunction getNewExpression (elements: string[]) {\n  return t.newExpression(\n    t.identifier('Set'),\n    [t.arrayExpression(elements.map(el => t.stringLiteral(el)))]\n  )\n}\n"],"names":["isArray","isString","path.resolve","parser.parse","t.newExpression","t.identifier","t.arrayExpression","t.stringLiteral"],"mappings":"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"}